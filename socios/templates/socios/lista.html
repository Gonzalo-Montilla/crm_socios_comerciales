{% extends 'base.html' %}
{% load humanize %}

{% block title %}Socios Comerciales - CRM{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="card-title">
                            <i class="fas fa-handshake me-2"></i>Socios Comerciales
                        </h4>
                    </div>
                    <div class="col-md-6 text-end">
                        <a href="{% url 'socios:crear' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-plus me-1"></i>Nuevo Socio
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas de Socios Comerciales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stats-card stats-info">
            <div class="card-body">
                <div class="stats-info">
                    <h6 class="stats-title">Total Socios</h6>
                    <div class="stats-value">{{ total_socios_registrados|intcomma }}</div>
                    <p class="stats-subtitle">Registrados</p>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card stats-success">
            <div class="card-body">
                <div class="stats-info">
                    <h6 class="stats-title">Con Ventas</h6>
                    <div class="stats-value">{{ socios_con_ventas|intcomma }}</div>
                    <p class="stats-subtitle">Activos comercialmente</p>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card stats-warning">
            <div class="card-body">
                <div class="stats-info">
                    <h6 class="stats-title">Este Mes</h6>
                    <div class="stats-value">{{ socios_ventas_mes_actual|intcomma }}</div>
                    <p class="stats-subtitle">{{ nombre_mes_actual }}</p>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card stats-primary">
            <div class="card-body">
                <div class="stats-info">
                    <h6 class="stats-title">Ventas Totales</h6>
                    <div class="stats-value">${{ ventas_totales_socios|floatformat:0|intcomma }}</div>
                    <p class="stats-subtitle">Históricamente</p>
                </div>
                <div class="stats-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" name="q" value="{{ query }}" 
                               placeholder="Buscar por nombre o ciudad...">
                    </div>
                    <div class="col-md-3">
                        <select name="activo" class="form-select">
                            <option value="">Todos los estados</option>
                            <option value="true" {% if activo == 'true' %}selected{% endif %}>Activos</option>
                            <option value="false" {% if activo == 'false' %}selected{% endif %}>Inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a href="{% url 'socios:lista' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Limpiar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Lista de socios -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if socios %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Ciudad</th>
                                <th>Fecha Ingreso</th>
                                <th>Estado</th>
                                <th>Ventas</th>
                                <th>Clientes</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for socio in socios %}
                            <tr>
                                <td>
                                    <strong>{{ socio.nombre }}</strong>
                                    {% if socio.email %}
                                    <br><small class="text-muted">{{ socio.email }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ socio.ciudad_sede }}</td>
                                <td>{{ socio.fecha_ingreso|date:"d/m/Y" }}</td>
                                <td>
                                    {% if socio.activo %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactivo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if socio.total_ventas %}
                                        ${{ socio.total_ventas|floatformat:0 }}
                                    {% else %}
                                        <span class="text-muted">Sin ventas</span>
                                    {% endif %}
                                </td>
                                <td>{{ socio.cantidad_ventas|default:"0" }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'socios:detalle' socio.pk %}" class="btn btn-sm btn-outline-info" title="Ver detalles">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if socio.documento_contrato %}
                                            <button class="btn btn-sm btn-outline-success" title="Ver contrato" data-bs-toggle="modal" data-bs-target="#contratoModal" onclick="cargarContrato('{% url 'socios:ver_contrato' socio.pk %}', '{{ socio.nombre }}')">
                                                <i class="bi bi-file-earmark-pdf"></i>
                                            </button>
                                        {% else %}
                                            <span class="btn btn-sm btn-outline-secondary disabled" title="Sin contrato">
                                                <i class="bi bi-file-earmark-x"></i>
                                            </span>
                                        {% endif %}
                                        <a href="{% url 'socios:editar' socio.pk %}" class="btn btn-sm btn-outline-warning" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{% url 'socios:eliminar' socio.pk %}" class="btn btn-sm btn-outline-danger" title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                {% if is_paginated %}
                <nav aria-label="Paginación">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if activo %}&activo={{ activo }}{% endif %}">Anterior</a>
                            </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if activo %}&activo={{ activo }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if activo %}&activo={{ activo }}{% endif %}">Siguiente</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-briefcase" style="font-size: 4rem; color: #ccc;"></i>
                    <h4 class="mt-3 text-muted">No hay socios comerciales</h4>
                    <p class="text-muted">Comienza creando tu primer socio comercial.</p>
                    <a href="{% url 'socios:crear' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Crear Primer Socio
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar contrato -->
<div class="modal fade" id="contratoModal" tabindex="-1" aria-labelledby="contratoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contratoModalLabel">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Contrato - <span id="nombreSocio"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="contratoFrame" src="" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function cargarContrato(url, nombreSocio) {
    // Actualizar el nombre del socio en el modal
    document.getElementById('nombreSocio').textContent = nombreSocio;
    
    // Cargar el contrato directamente en el iframe
    const iframe = document.getElementById('contratoFrame');
    iframe.src = url;
}

// Limpiar iframe cuando se cierre el modal
document.getElementById('contratoModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('contratoFrame').src = '';
});
</script>
{% endblock %}
